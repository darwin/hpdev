#!/usr/bin/env ruby

require 'rubygems'
require 'trollop'

begin
  require 'pbdev'
rescue LoadError
  # special case for my development machine, where I have this file on path and no pbdev gem installed
  $: << File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))
  require 'pbdev'
end

include PBDev

SUB_COMMANDS = %w(bake, serve)
opts = Trollop::options do
  banner "PageBout developer tools"
  version "pbdev v0.1 (c) 2009 Antonin Hildebrand"
  stop_on SUB_COMMANDS
  opt :url, "destination url to be written into resource", :type => String
  opt :workspace, "workspace root for dev server", :type => String
  opt :mode, "server mode (development, production)", :type => String
end

cmd = ARGV.shift # get the subcommand
cmd = "serve" unless cmd
cmd_opts = case cmd
  when "bake"
    subcmd = ARGV.shift # get the subsubcommand
    case subcmd
      when "skin"
      when "widget"
      when "engine"
      when "editor"
    else
      Trollop::die "Unknown subcommand for bake. Specify skin or widget"
    end
end

# puts "Options: #{opts.inspect}"
# puts "Subcommand: #{cmd.inspect}"
# puts "Remaining arguments: #{ARGV.inspect}"

case cmd
  when "serve"
    workspace = File.expand_path(opts[:workspace] || ".")
    mode = opts[:mode] || "development"
    `env PBDEV_WORKSPACE="#{workspace}" PBDEV_MODE="#{mode}" ruby #{PBDEV_LIB_LOCATION}/pbdev-server.rb -p 9876`
  when "bake"
    url = opts[:url] || "http://examle.com"
    source = File.expand_path(ARGV[0] || '.')
    dest = File.expand_path(ARGV[1] || '.')
    case subcmd
      when "skin" 
        klass = SkinRepo
      when "widget" 
        klass = WidgetRepo
      when "engine" 
        klass = EngineRepo
      when "editor" 
        klass = EditorRepo
    end
    begin
      resource = klass.new(source, url)
    rescue Grit::InvalidGitRepositoryError
      Trollop::die "Error: #{source} is not valid Git repository"
    rescue Grit::NoSuchPathError
      Trollop::die "Error: no such path #{source}"
    end
    resource.bake(dest)
    puts "Resource baked into #{dest}"
end

exit(0)